<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ball & Coin Detector</title>
    <link rel="stylesheet" href="src/css/styles.css">
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: auto;
            aspect-ratio: 1 / 1;
            margin: 20px auto;
            background: #000;
            overflow: hidden;
        }
        #videoFeed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        #outputCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        #controls {
            margin: 20px 0;
            width: 100%;
            max-width: 640px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrap on smaller screens */
        }
        button {
            padding: 15px 30px;
            margin: 0 10px 10px 10px; /* Add bottom margin for wrapping */
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        button:active {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #debugPanel {
            width: 100%;
            max-width: 640px;
            height: 200px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 20px;
            -webkit-overflow-scrolling: touch;
        }
        /* Add debug buttons */
        #debugControls {
            margin: 10px 0;
            width: 100%;
            max-width: 640px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .debug-button {
            background-color: #555;
            margin: 5px;
            font-size: 14px;
            padding: 10px 15px;
        }
        /* Responsive design for iOS devices */
        @media only screen and (max-width: 767px) {
            #videoContainer {
                width: 95%;
                height: auto;
            }
            body {
                padding: 10px;
            }
            button {
                padding: 15px 0;
                margin: 0 5px 10px 5px;
                min-width: 140px;
            }
            #controls {
                flex-direction: row;
            }
            h1 {
                font-size: 24px;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <h1>Ball & Coin Detector</h1>
    
    <div id="videoContainer">
        <video id="videoFeed" 
               playsinline 
               autoplay 
               muted
               webkit-playsinline
        ></video>
        <canvas id="outputCanvas"></canvas>
    </div>

    <div id="controls">
        <button id="startButton" type="button" onclick="startCameraFromHTML()">Start Camera</button>
        <button id="stopButton" type="button" disabled>Stop Camera</button>
    </div>

    <!-- iOS Camera Access Fix -->
    <script>
        // Direct camera start function that works better on iOS
        function startCameraFromHTML() {
            console.log('Start button clicked directly from HTML');
            // Feature detection
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('Camera API supported, requesting camera');
                // Simple constraints for iOS
                navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                }).then(function(stream) {
                    console.log('Camera access granted!');
                    const video = document.getElementById('videoFeed');
                    video.srcObject = stream;
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('muted', 'true');
                    video.setAttribute('autoplay', 'true');
                    video.play().catch(function(error) {
                        console.error('Video play error:', error);
                        document.getElementById('debugPanel').innerHTML += 
                            `<div style="color:#ff4444">Video play error: ${error.message}</div>`;
                    });
                    
                    // Now trigger the main app's camera start...
                    try {
                        const mainStartButton = document.getElementById('startButton');
                        console.log('Triggering main app camera start...');
                        // The main app's event handler will be called from main.js
                    } catch(error) {
                        console.error('Error triggering main app:', error);
                    }
                }).catch(function(error) {
                    console.error('Camera access error:', error);
                    document.getElementById('debugPanel').innerHTML += 
                        `<div style="color:#ff4444">Camera error: ${error.message}</div>`;
                    alert('Camera access was denied or error occurred. Please check permissions and try again.');
                });
            } else {
                console.error('Camera API not supported');
                alert('Your browser does not support camera access.');
            }
        }
    </script>

    <!-- Debug controls for iOS testing -->
    <div id="debugControls">
        <button id="permissionButton" type="button" class="debug-button">Request Permission</button>
        <button id="checkModelButton" type="button" class="debug-button">Check Model</button>
        <button id="testTensorButton" type="button" class="debug-button">Test Tensor</button>
        <button id="clearCanvasButton" type="button" class="debug-button">Clear Canvas</button>
    </div>

    <div id="debugPanel"></div>

    <!-- Load TensorFlow.js first -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
    
    <!-- Initialize TensorFlow.js -->
    <script>
        // Check TensorFlow.js initialization
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Initializing TensorFlow.js...');
                // Force WebGL backend for iOS
                await tf.setBackend('webgl');
                // Wait for TensorFlow.js to be ready
                await tf.ready();
                console.log('TensorFlow.js initialized successfully');
                console.log('TensorFlow.js version:', tf.version.tfjs);
                console.log('Backend:', tf.getBackend());
                
                // Test tensor operations
                const testTensor = tf.tensor2d([[1, 2], [3, 4]]);
                console.log('Test tensor created:', testTensor.shape);
                testTensor.dispose();
                
                // Set a global flag that our main script can check
                window.tensorflowReady = true;
            } catch (error) {
                console.error('TensorFlow.js initialization failed:', error);
                alert('Failed to initialize TensorFlow.js. The application may not work correctly.');
            }
        });
    </script>

    <!-- Debug script -->
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const debugPanel = document.getElementById('debugPanel');
            
            function addDebugMessage(message, type = 'info') {
                const colors = {
                    info: '#fff',
                    error: '#ff4444',
                    success: '#44ff44',
                    warning: '#ffff44'
                };
                
                const entry = document.createElement('div');
                entry.style.color = colors[type] || colors.info;
                entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                debugPanel.insertBefore(entry, debugPanel.firstChild);
                
                // Keep only last 20 messages
                while (debugPanel.children.length > 20) {
                    debugPanel.removeChild(debugPanel.lastChild);
                }
                
                // Also log to console
                console.log(message);
            }
            
            // Log device info
            console.log('DOM loaded');
            addDebugMessage('App started', 'info');
            console.log('User Agent:', navigator.userAgent);
            addDebugMessage(`User Agent: ${navigator.userAgent}`, 'info');
            
            const video = document.getElementById('videoFeed');
            const canvas = document.getElementById('outputCanvas');
            console.log('Video element:', video);
            console.log('Canvas element:', canvas);
            
            // Add video element event listeners for debugging
            video.addEventListener('play', () => {
                console.log('Video play event');
                addDebugMessage('Video play event', 'success');
            });
            video.addEventListener('pause', () => {
                console.log('Video pause event');
                addDebugMessage('Video pause event', 'info');
            });
            video.addEventListener('loadedmetadata', () => {
                console.log('Video loadedmetadata event');
                addDebugMessage('Video metadata loaded', 'info');
            });
            video.addEventListener('loadeddata', () => {
                console.log('Video loadeddata event');
                addDebugMessage('Video data loaded', 'info');
            });
            video.addEventListener('playing', () => {
                console.log('Video playing event');
                addDebugMessage('Video playing', 'success');
            });
            video.addEventListener('waiting', () => {
                console.log('Video waiting event');
                addDebugMessage('Video waiting', 'warning');
            });
            video.addEventListener('error', (e) => {
                console.error('Video error event:', e);
                addDebugMessage(`Video error: ${e.target.error ? e.target.error.message : 'Unknown error'}`, 'error');
            });
            
            // Add iOS debug controls
            const permissionButton = document.getElementById('permissionButton');
            const checkModelButton = document.getElementById('checkModelButton');
            const testTensorButton = document.getElementById('testTensorButton');
            const clearCanvasButton = document.getElementById('clearCanvasButton');
            
            // Explicit permission request button (important for iOS)
            permissionButton.addEventListener('click', async () => {
                addDebugMessage('Requesting camera permission...', 'info');
                
                try {
                    // Request minimal video access to trigger the permission dialog
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: false 
                    });
                    
                    addDebugMessage('Camera permission granted!', 'success');
                    
                    // Stop the stream right away - we just needed the permission
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Enable the main start button
                    document.getElementById('startButton').disabled = false;
                    addDebugMessage('Start button enabled - click it to start camera', 'success');
                    
                } catch (error) {
                    addDebugMessage(`Permission error: ${error.message}`, 'error');
                    console.error('Permission error:', error);
                    alert('Camera permission was denied. Please enable camera access in your browser settings.');
                }
            });
            
            checkModelButton.addEventListener('click', async () => {
                try {
                    addDebugMessage('Checking model URL...', 'info');
                    const modelUrl = './src/assets/my_model_web_model_2/model.json';
                    
                    const response = await fetch(modelUrl, { method: 'HEAD' });
                    if (response.ok) {
                        addDebugMessage(`Model URL check: OK (${response.status})`, 'success');
                        
                        // Try to load model JSON
                        try {
                            const jsonResponse = await fetch(modelUrl);
                            const modelJson = await jsonResponse.json();
                            addDebugMessage('Model JSON parsed successfully', 'success');
                        } catch (jsonError) {
                            addDebugMessage(`Model JSON parse error: ${jsonError.message}`, 'error');
                        }
                    } else {
                        addDebugMessage(`Model URL check failed: ${response.status} ${response.statusText}`, 'error');
                    }
                } catch (error) {
                    addDebugMessage(`Model check error: ${error.message}`, 'error');
                }
            });
            
            testTensorButton.addEventListener('click', async () => {
                try {
                    addDebugMessage('Creating test tensor...', 'info');
                    const tensor = tf.zeros([1, 224, 224, 3]);
                    addDebugMessage(`Test tensor created: ${tensor.shape}`, 'success');
                    
                    // Try basic operations
                    addDebugMessage('Testing tensor operations...', 'info');
                    const scaled = tf.mul(tensor, tf.scalar(255));
                    addDebugMessage('Multiplication operation succeeded', 'success');
                    
                    // Clean up
                    tf.dispose([tensor, scaled]);
                    addDebugMessage('Tensors disposed', 'success');
                } catch (error) {
                    addDebugMessage(`Tensor test error: ${error.message}`, 'error');
                }
            });
            
            clearCanvasButton.addEventListener('click', () => {
                try {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    addDebugMessage('Canvas cleared', 'info');
                } catch (error) {
                    addDebugMessage(`Clear canvas error: ${error.message}`, 'error');
                }
            });
        });
    </script>

    <!-- Load our main script last -->
    <script type="module" src="src/js/main.js"></script>
</body>
</html>